# ai_service.py
import logging

from openai import OpenAI
from config import OPENAI_API_KEY

logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI-–∫–ª–∏–µ–Ω—Ç –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –º–æ–¥—É–ª—å
openai_client = OpenAI(api_key=OPENAI_API_KEY) if OPENAI_API_KEY else None


def load_system_prompt() -> str:
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ system_prompt.txt."""
    try:
        with open("system_prompt.txt", "r", encoding="utf-8") as f:
            return f.read()
    except FileNotFoundError:
        # –ó–∞–ø–∞—Å–Ω–æ–π –¥–µ—Ñ–æ–ª—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
        return """–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∏—Å–µ–º –∫ —Ä–µ–∑—é–º–µ. 
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–±–µ:
1. –°–Ω–∞—á–∞–ª–∞ —Å–≤–æ–µ —Ä–µ–∑—é–º–µ (—Ç–µ–∫—Å—Ç –∏–ª–∏ PDF)
2. –ü–æ—Ç–æ–º –≤–∞–∫–∞–Ω—Å–∏—é (—Å—Å—ã–ª–∫—É –∏–ª–∏ —Ç–µ–∫—Å—Ç)

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑—é–º–µ –≤–∞–∫–∞–Ω—Å–∏–∏
2. –í—ã–¥–µ–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
3. –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
4. –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–µ–∑—é–º–µ

–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –¥–µ–ª–æ–≤—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º."""


async def analyze_vacancy(message, resume_text: str, vacancy_text: str) -> None:
    """
    –ê–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI.
    –°—é–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç —É–∂–µ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ –∏ —Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏.
    """
    if not openai_client:
        await message.reply_text("‚ùå OpenAI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ OPENAI_API_KEY")
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç –¥—É–º–∞–µ—Ç
    await message.chat.send_action(action="typing")

    try:
        system_prompt = load_system_prompt()

        prompt = f"""
–ê–ù–ê–õ–ò–ó –°–û–ü–†–û–í–û–î–ò–¢–ï–õ–¨–ù–û–ì–û –ü–ò–°–¨–ú–ê

–†–ï–ó–Æ–ú–ï –ö–ê–ù–î–ò–î–ê–¢–ê:
{resume_text[:3000]}

–¢–ï–ö–°–¢ –í–ê–ö–ê–ù–°–ò–ò:
{vacancy_text[:3000]}

–ó–ê–î–ê–ß–ê:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑—é–º–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –≤–∞–∫–∞–Ω—Å–∏–∏
2. –í—ã–¥–µ–ª–∏—Ç—å 3-5 –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–∞–≤—ã–∫–æ–≤ –∏ –æ–ø—ã—Ç–∞
3. –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
4. –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ (—á—Ç–æ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –≤ —Ä–µ–∑—é–º–µ)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
üìä –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
‚úÖ –ö–ª—é—á–µ–≤—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
üìù –ì–æ—Ç–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ

–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –¥–µ–ª–æ–≤—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º.
"""

        response = openai_client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=2000
        )

        ai_response = response.choices[0].message.content or "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if len(ai_response) > 4000:
            parts = [ai_response[i:i + 4000] for i in range(0, len(ai_response), 4000)]
            for i, part in enumerate(parts, 1):
                await message.reply_text(f"üìÑ –ß–∞—Å—Ç—å {i}/{len(parts)}:\n\n{part}")
        else:
            await message.reply_text(ai_response)

        logger.info(f"‚úÖ OpenAI –æ—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤")

    except Exception as e:
        logger.error(f"‚ùå OpenAI –æ—à–∏–±–∫–∞: {str(e)}", exc_info=True)
        await message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —á–µ—Ä–µ–∑ AI.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ."
        )
